// Setup new project with CLAUDE.md and registry update
const fs = require('fs');
const path = require('path');

// Get command line arguments
const [,, projectName, category, projectType, githubUrl] = process.argv;

if (!projectName || !category || !projectType) {
    console.error('Usage: node setup-new-project.js <projectName> <category> <projectType> [githubUrl]');
    process.exit(1);
}

const projectPath = path.join('D:', 'Projects', projectName);
const masterPath = 'D:/.Master';
const registryPath = path.join(masterPath, 'project-registry.json');

// Load existing registry
let registry = { projects: {} };
if (fs.existsSync(registryPath)) {
    try {
        registry = JSON.parse(fs.readFileSync(registryPath, 'utf8'));
    } catch (error) {
        console.warn('Warning: Could not load existing registry, creating new one');
    }
}

// Create domain module if it doesn't exist
const domainPath = path.join(masterPath, 'modules', 'domains', `${category}.md`);
if (!fs.existsSync(domainPath)) {
    console.log(`Creating new domain module: ${category}`);
    
    // Create domains directory if it doesn't exist
    const domainsDir = path.dirname(domainPath);
    if (!fs.existsSync(domainsDir)) {
        fs.mkdirSync(domainsDir, { recursive: true });
    }
    
    // Create basic domain module
    const domainContent = `# ${category.charAt(0).toUpperCase() + category.slice(1)} Domain Module

## Domain Overview
This domain handles ${category.replace('-', ' ')} projects and their specific requirements.

## Quality Gates
- Performance targets appropriate for ${category}
- Code quality standards
- Testing requirements
- Documentation standards

## Specialized Tools
- Domain-specific development tools
- Testing frameworks
- Build and deployment scripts
- Monitoring and analytics

## Common Patterns
- Project structure conventions
- Coding patterns and best practices
- Configuration management
- Dependency management

## Expert Knowledge
- ${category.replace('-', ' ')} best practices
- Performance optimization techniques
- Security considerations
- Scalability patterns

---
*This domain module was auto-generated for ${projectName}*
`;
    
    fs.writeFileSync(domainPath, domainContent);
}

// Create CLAUDE.md for the new project
const claudeContent = `# ${projectName} - AI Assistant Instructions

## Project Overview
- **Name**: ${projectName}
- **Type**: ${projectType}
- **Domain**: ${category}
- **Repository**: ${githubUrl || 'Not set'}

## Master System Inheritance
\`\`\`markdown
INHERIT: D:/.Master/HYBRID_MASTER_CLAUDE.md
DOMAIN: ${category}
\`\`\`

## Project-Specific Instructions

### Context
This is a ${projectType} project in the ${category.replace('-', ' ')} domain.

### Specialized Behavior
- Follow ${category.replace('-', ' ')} best practices
- Optimize for ${projectType} development patterns
- Maintain project-specific quality standards

### Key Files & Structure
${projectType === 'node' ? `- package.json - Project dependencies and scripts
- src/ - Source code directory
- README.md - Project documentation` : ''}${projectType === 'python' ? `- main.py - Main application entry point  
- requirements.txt - Python dependencies
- src/ - Source code directory` : ''}${projectType === 'web' ? `- index.html - Main HTML file
- style.css - Stylesheets
- script.js - JavaScript functionality` : ''}

### Development Workflow
1. Use domain-specific patterns from master system
2. Follow ${projectType} conventions
3. Maintain cross-project compatibility
4. Update project registry when structure changes

### Quality Standards
- Code quality appropriate for ${category}
- Testing coverage requirements
- Documentation standards
- Performance targets

---

## Cross-Project Integration
This project can:
- Access other projects via master discovery system
- Share utilities and patterns with similar domain projects
- Contribute learnings back to domain knowledge base

## Notes
- Created: ${new Date().toISOString().split('T')[0]}
- Initial setup: Basic ${projectType} structure
- Domain: ${category}

---
*Generated by Master AI System - Project Creator*
`;

// Write CLAUDE.md
const claudePath = path.join(projectPath, 'CLAUDE.md');
fs.writeFileSync(claudePath, claudeContent);

// Update project registry
registry.projects[projectName] = {
    path: projectPath.replace(/\\/g, '/'),
    type: projectType,
    domain: category,
    branch: null, // Will be set after first commit
    hasUncommittedChanges: true, // New project, not yet committed
    remote: githubUrl || null,
    created: new Date().toISOString(),
    status: 'new'
};

// Update registry metadata
registry.lastUpdated = new Date().toISOString();
registry.totalProjects = Object.keys(registry.projects).length;
registry.projectsPath = registry.projectsPath || 'D:/Projects';
registry.masterPath = registry.masterPath || 'D:/.Master';
registry.platform = registry.platform || 'windows';

// Write updated registry
fs.writeFileSync(registryPath, JSON.stringify(registry, null, 2));

console.log(`‚úÖ Project ${projectName} created successfully!`);
console.log(`üìÅ Location: ${projectPath}`);
console.log(`üè∑Ô∏è  Domain: ${category}`);
console.log(`üîß Type: ${projectType}`);
console.log(`üìã Registry updated with ${Object.keys(registry.projects).length} total projects`);

if (!githubUrl) {
    console.log(`‚ö†Ô∏è  No GitHub URL provided - you can add it later`);
}

// Create .gitignore based on project type
let gitignoreContent = `# General
.DS_Store
Thumbs.db
*.log
.env
.env.local

# IDE
.vscode/
.idea/
*.swp
*.swo

# Claude
.claude-last-session
.claude-project-init
.claude/settings.local.json
`;

if (projectType === 'node') {
    gitignoreContent += `
# Node.js
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*
dist/
build/
`;
}

if (projectType === 'python') {
    gitignoreContent += `
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
env/
venv/
.venv/
pip-log.txt
`;
}

fs.writeFileSync(path.join(projectPath, '.gitignore'), gitignoreContent);

console.log(`üìù Created .gitignore for ${projectType} project`);
console.log(`üìÑ Created CLAUDE.md with domain inheritance`);

// If new domain was created, mention it
if (!fs.existsSync(domainPath.replace('.md', '_backup.md'))) {
    console.log(`üÜï Created new domain module: ${category}`);
}